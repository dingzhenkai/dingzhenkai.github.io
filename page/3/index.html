<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="utf-8" />
   
  <meta name="keywords" content="丁星乐、学习、工作、生活" />
   
  <meta name="description" content="分享丁星乐的学习、工作与享乐时光" />
  
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1" />
  <title>
     丁星乐
  </title>
  <meta name="generator" content="hexo-theme-yilia-plus">
  
  <link rel="shortcut icon" href="/favicon.ico" />
  
  
<link rel="stylesheet" href="/css/style.css">

  
<script src="/js/pace.min.js"></script>


  

  

</head>

</html>

<body>
  <div id="app">
    <main class="content">
      
<section class="cover">
    
      
      <a class="forkMe" href="https://github.com/dingzhenkai"
        target="_blank"><img width="149" height="149" src="/images/forkme.png"
          class="attachment-full size-full" alt="Fork me on GitHub" data-recalc-dims="1"></a>
    
  <div class="cover-frame">
    <div class="bg-box">
      <img src="/images/cover.jpg" alt="image frame" />
    </div>
    <div style="color:#000" class="cover-inner text-center text-white">
      <h1><a style="color:#000" href="/">丁星乐</a></h1>
      <div id="subtitle-box">
        
        <span id="subtitle"></span>
        
      </div>
      <div>
        
      </div>
    </div>
  </div>
  <div class="cover-learn-more">
    <a href="javascript:void(0)" class="anchor"><i class="ri-arrow-down-line"></i></a>
  </div>
</section>


<div id="main">
  <section class="outer">
  <article class="articles">
    
    
    
    
    <article id="post-从技术演变的角度看互联网后台架构" class="article article-type-post" itemscope
  itemprop="blogPost" data-scroll-reveal>

  <div class="article-inner">
    
    <header class="article-header">
       
<h2 itemprop="name">
  <a class="article-title" href="/2020/11/12/%E4%BB%8E%E6%8A%80%E6%9C%AF%E6%BC%94%E5%8F%98%E7%9A%84%E8%A7%92%E5%BA%A6%E7%9C%8B%E4%BA%92%E8%81%94%E7%BD%91%E5%90%8E%E5%8F%B0%E6%9E%B6%E6%9E%84/"
    >从技术演变的角度看互联网后台架构</a
  >
</h2>
  

    </header>
    

    
    <div class="article-meta">
      <a href="/2020/11/12/%E4%BB%8E%E6%8A%80%E6%9C%AF%E6%BC%94%E5%8F%98%E7%9A%84%E8%A7%92%E5%BA%A6%E7%9C%8B%E4%BA%92%E8%81%94%E7%BD%91%E5%90%8E%E5%8F%B0%E6%9E%B6%E6%9E%84/" class="article-date">
  <time datetime="2020-11-12T13:53:33.000Z" itemprop="datePublished">2020-11-12</time>
</a>
      
  <div class="article-category">
    <a class="article-category-link" href="/categories/%E5%90%8E%E7%AB%AF/">后端</a>
  </div>

      
      
      
    </div>
    

    

    <div class="article-entry" itemprop="articleBody">
      


      

      
      <p>转载自 <a href="https://zhuanlan.zhihu.com/p/59591449" target="_blank" rel="noopener">https://zhuanlan.zhihu.com/p/59591449</a></p>
<p>这是去年在部门内部做的一个面向后台开发新同学的课程，因为其他BG一些同学要求分享，所以发一下。</p>
<p>其实内容都是些常见开源组件的high level描述，比如flask, express框架，中间件的演化，micro service的概念，一些对nosql/column based db的概念介绍，docker的一些简单概念等等。从单个概念来说，这只是一些科普。</p>
<p>但是为什么当时要开这门课呢？重点是我发现很多新入职的后台开发同学并不太清楚自己做的东西在现代互联网整体架构中处于一个什么样的角色，而在IEG内部则因为游戏开发和互联网开发的一些历史性差异，有些概念并不清晰。</p>
<p>拿中间件来说，很多web application不用啥中间件一样可以跑很好，那么是不是都要上redis？到底解决什么问题？中间件又存在什么问题？中台和中间件又是个什么关系？如果开个mq就是中间件，微服务又是要做啥？</p>
<p>如果能从这十多年来互联网应用的整个tech stack变化去看待backend architecture的一些改变，应该是一件有趣也有意思的事情。这是当时写这个ppt开课的初衷。</p>
<p>我不敢说我在这个ppt里面的一些私货概念就是对的，但是也算是个人这么多年的一些认知理解，抛砖引玉吧。</p>
<p>强调一点，这个ppt的初衷是希望从近十多年来不同时代不同热点下技术栈的变化来看看我们是如何从最早的php/asp/jsp&lt;=&gt;mysql这样的两层架构，一个阶段一个阶段演变到现在繁复的大数据、机器学习、消息驱动、微服务架构这样的体系，然后在针对其中比较重要的几个方面来给新入门后台开发的同学起个“提纲目录”的作用。如果要对每个方面都深入去谈，那肯定不是一两页PPT就能做到的事情。</p>
<p>下面我们开始。首先看第一页如下图：什么是System Design?什么是架构设计？为什么要谈架构设计？</p>
<p><img src="https://pic4.zhimg.com/80/v2-2b1dc48a958b265dd1a5a6e5930dce37_1440w.jpg" alt="img"></p>
<p>之所以抛出这个问题，是因为平时常常听到两个互相矛盾的说法：一方面很多人爱说“架构师都是不干活夸夸其谈”，另一方面又有很多人苦恼限于日常业务需求开发，无法或者没有机会去从整体架构思考，不知道怎么成长为架构师。</p>
<p>上面ppt中很有趣的是第一句英文，翻译过来恰好可以反映了论坛上经常有人问的“如何学习架构”的问题：很多leader一来就是扔几本书（书名）给新同学，期望他们读完书就马上升级。。。这种一般都只会带来失望。</p>
<p>何为架构师？不写代码只画PPT？</p>
<p>不是的，架构师的基本职责是要在项目早期就能设计好基本的框架，这个框架能够确保团队成员顺利coding满足近期内业务需求的变化，又能为进一步的发展留出空间（所谓scalability），这即是所谓技术选型。如何确保选型正确？对于简单的应用，或者没有新意完全是实践过多次的相同方案，确实靠几页PPT足矣。但是对于新的领域新的复杂需求，这个需求未必都是业务需求，也包括根据团队自身特点（人员太多、太少、某些环节成员不熟悉需要剥离开）来进行新的设计，对现有技术重新分解组合，这时候就需要架构师自己编码实现原型并验证思路正确性。</p>
<p>要达到这样的目标难不难？难！但是现在不是2000年了，是2019年了，大量的框架(framework)、开源工具和各种best practice，其实都是在帮我们解决这件事情。而这些框架并不是凭空而来，而是在这十多年互联网的演化中因为要解决各种具体业务难点而一点一点积累进化而来。无论是从mysql到mongodb到cassandra到time series db，或者从memcached到redis，从lucene到solr到elasticsearch，从离线批处理到hadoop到storm到spark到flink，技术不是突然出现的，总是站在前人的肩膀上不断演变的。而要能在浩如烟海的现代互联网技术栈中选择合适的来组装自己的方案，则需要对技术的来源和历史有一定的了解。否则就会出现一些新人张口ELK，闭口tensorflow，然后一个简单的异步消息处理就会让他们张口结舌的现象。</p>
<p>20多年前的经典著作DesignPatterns中讲过学习设计模式的意义，放在这里非常经典：学习设计模式并不是要你学习一种新的技术或者编程语言，而是建立一种交流的共同语言和词汇，在方案设计时方便沟通，同时也帮助人们从更抽象的层次去分析问题本质，而不被一些实现的细枝末节所困扰。同时，当我们能把很多问题抽象出来之后，也能帮我们更深入更好地去了解现有系统——-这些意义，对于今天的后端系统设计来说，也仍然是正确的。</p>
<p>下图是我们要谈的几个主要方面。</p>
<p><img src="https://pic4.zhimg.com/80/v2-97fefe6be62d1017f485235d758aa097_1440w.jpg" alt="img"></p>
<p>上面的几个主题中，第一个后台架构的演化是自己从业十多年来，体会到的互联网技术架构的整体变迁。然后分成后台前端应用框架、middleware和存储三大块谈一下，最后两节微服务和docker则是给刚进入后台开发的同学做一些概念普及。其中个人觉得最有趣的，是第一部分后台架构的演化和第三部分的中间件，因为这两者是很好地反映了过去十多年互联网发展期间技术栈的变化，从LAMP到MEAN Stack，从各种繁复的中间层到渐渐统一的消息驱动+流处理，每个阶段的业界热点都相当有代表性。</p>
<p>当然，不是说web框架、数据存储就不是热点了，姑且不说这几年web前端的复杂化，光后端应用框架，node的express，python的django/flask，go在国内的盛行，都是相当有趣的。在数据存储领域，列存储和时序数据随着物联网的发展也是备受重视。但是篇幅所限，在这个课程中这些话题也就只能一带而过，因为这些与其说是技术的演变过程，不如说是不同的技术选型和方向了，比如说Mysql适合OLTP（Online Transaction Processing），而Cassandra/Hbase等则适合OLAP(Online Analyical Processing)，并不能说后者就优于前者。</p>
<p>下面我们先来看后台架构的演化</p>
<p><img src="https://pic2.zhimg.com/80/v2-c2c0732c96eb53e8e2cb8f7ffbf96a79_1440w.jpg" alt="img"></p>
<p>严格说这是个很大的标题，从2000年到现在的故事太多了，我这里只能尽力而为从个人体验来分析。</p>
<p>首先是2008年以前，我把它称为网站时代。为什么这么说？因为那时候的后台开发就是写网站，而且通常是页面代码和后台数据逻辑一起写。你只要能写JSP/PHP/ASP来读写Mysql或者SQL Server，基本就能保证一份不错的工作了。</p>
<p><img src="https://pic4.zhimg.com/80/v2-d8bbc2b35f5a810170ec482f8ce20857_1440w.jpg" alt="img"></p>
<p>要强调一下，这种简单的两层结构并不能说就是落后。在现在各个企业、公司以及小团队的大量web应用包括移动App的后端服务中，采用这种架构的不在少数，尤其是很多公司、学校、企业的内部服务，用这种架构已经足够了。</p>
<p>注意一个时间节点：2008。</p>
<p>当然，这个节点是我YY的。这个节点可以是2007，或者2006。这个时间段发生了两个影响到现在的事情：google上市，facebook开始推开</p>
<p>我个人相信前者上市加上它发表的那三篇大数据paper影响了后来业界的技术方向，后者的火热则造成了社交成为业务热点。偏偏社交网站对大数据处理有着天然的需求，技术的积累和业务的需求就这么阴差阳错完美结合了起来，直接影响了大海那边后面的科技发展。</p>
<p>同时在中国，那个时候却是网络游戏MMO的黄金年代，对单机单服高并发实时交互的需求，远远压过了对海量数据data mining的需要，在这个时间点，中美两边的互联网科技树发生了比较大的分叉。这倒是并没有优劣之说，只是业务场景的重要性导致了技能树的侧重。直到今天，单机(包括简单的多服务器方案)高并发、高QPS仍然也是国内业界所追求的目标，而在美国那边，这只是一个业务指标而已，更看重的是如何进行水平扩展(horizontal scaling)和分散压力。</p>
<p>国内和美国的科技树回到一条线上，大数据的业务需求和相关技术发展紧密结合起来，可能要到2014年左右，随着互联网创业的盛行，O2O业务对大数据实时处理、机器学习推荐提出了真正的需求时，才是国内业界首次出现技术驱动业务，算法驱动产品的现象，重新和美国湾区那边站在了一条线上，而这则是后话了。</p>
<p><img src="https://pic3.zhimg.com/80/v2-e27797679646e518bc580a2d6dd08502_1440w.jpg" alt="img"></p>
<p>到了2010年前后，facebook在全球已经是现象级产品，当时微软直接放弃了windows live，就是为了避免在社交领域硬怼facebook。八卦一下当时在美国湾区那边聚餐的时候，如果谁说他是facebook的，那基本就是全场羡慕的焦点。</p>
<p>facebook的崛起也带动了其他大量的社交网站开始出现，社交网站最大的特点就是频繁的用户搜索、推荐，当用户上亿的时候，这就是前面传统的两层架构无法处理的问题了。因此这就带动了中间件的发展。实际上在国外很少有人用中间件或者middelware这个词，更多是探讨如何把各种service集成在一起，像国内这样强行分成frontend/middleware/storage的概念是没听人这么谈过的，后面中间件再说这问题。当时的一个惯例是用php做所谓的胶水语言(glue language)，然后通过hessian这些协议工具来把其他java服务连接到一起。与此同时，为了提高访问速度，降低后端查询压力，memcached/redis也开始大量使用。基于lucene的搜索（2010左右很多是自行开发）或者solr也被用在用户搜索、推荐以及type ahead这些场景中。</p>
<p>我记忆中在2012年之前消息队列的使用还不是太频繁，不像后来这么重要。当时常见的应该就是beanstalkd/rabbitmq, zeromq其实我在湾区那边很少听人用，倒是后来回国后看到国内用的人还不少。Kafka在2011年已经出现了，有少部分公司开始用，不过还不是主流。</p>
<p><img src="https://pic3.zhimg.com/80/v2-b72bb1ea0b9a2b4fbccfc5e7e494789e_1440w.jpg" alt="img"></p>
<p>2013年之后就是大数据+云的时代了，如果大家回想一下，基本上国内也是差不多在2014年左右开始叫出了云+大数据的口号（2013年国内还在手游狂潮中…）。不谈国外，在中国那段时间就是互联网创业的时代，从千团大战到手游爆发到15年开始的O2O，业务的发展也带动了技术栈的飞速进步。左上角大致上也写了这个时代互联网业界的主要技术热点，实际上这也就是现在的热点。无论国内国外，绝大部分公司还并没有离开云+大数据这个时代。无论是大数据的实时处理、数据挖掘、推荐系统、Docker化，包括A/B测试，这些都是很多企业还正在努力全面解决的问题。</p>
<p>但是在少数站在业界技术顶端或者没有历史技术包袱的新兴公司，从某个角度上来说，他们已经开始在往下一个时代前进：机器学习AI驱动的时代</p>
<p><img src="https://pic1.zhimg.com/80/v2-9591a31a85583b36088c41bcd974c324_1440w.jpg" alt="img"></p>
<p>2018年开始，实际上可能是2017年中开始，AI驱动成了各大公司口号。上图是facebook和uber的机器学习平台使用情况，基本上已经全部进入业务核心。当然并不是说所有公司企业都要AI驱动，显然最近发生的波音737事件就说明该用传统的就该传统，别啥都往并不成熟的AI上堆。但另一方面，很多新兴公司的业务本身就是基于大数据或者算法的，因此他们在这个领域也往往走得比较激进。由于这个AI驱动还并没有一个很明确的定义和概念，还处于一种早期萌芽的阶段，在这里也就不多YY了。</p>
<p>互联网后台架构发展的简单过程就在这里讲得差不多了，然后我们快速谈一下web开发框架。</p>
<p><img src="https://pic2.zhimg.com/80/v2-c338c389afc20aa6be4cf9a156bc8801_1440w.jpg" alt="img"></p>
<p>首先在前面我提到，在后端架构中其实也有所谓的frontend(前台）开发存在，一般来说这是指响应用户请求，实现具体业务逻辑的业务逻辑层。当然这么定义略微粗糙了些，很多中间存储、消息服务也会封装一些业务相关逻辑。总之web开发框架往往就是为了更方便地实现这些业务逻辑而存在的。</p>
<p>前文提到在一段较长时间内，国内的技术热点是单机高并发高QPS，因此很多那个时代走过来的人会本能地质疑web框架的性能，而更偏好TCP长链接甚至UDP协议。然而这往往是自寻烦恼，因为除开特别的强实时系统，无论是休闲手游、视频点播还是信息流，都已经是基于HTTP的了。</p>
<p><img src="https://pic2.zhimg.com/80/v2-204b4be768437cbf13bc8b47cab3be75_1440w.jpg" alt="img"></p>
<p>上图所提到的两个问题中，我想强调的是第一点：所有的业务，在能满足需求的情况下，首选HTTP协议进行数据交互。准确点说，首选JSON，使用web API。</p>
<p>Why? 这就是上图第一个问题所回答的：无状态、易调试易修改、一般没有80端口限制。</p>
<p>最为诟病的无非是性能，然而实际上对非实时应用，晚个半秒一秒不应该是大问题，要考虑的是水平扩展scalability，不是实时响应（因为前提就是非实时应用）；其次实在不行你还有websocket可以用。</p>
<p><img src="https://pic2.zhimg.com/80/v2-dacbc19c18e27bce3ed49915b1a09a7d_1440w.jpg" alt="img"></p>
<p>这一部分是简单列举了一下不同框架的使用，可以看出不同框架的概念其实差不多。重点是要注意到middleware这个说法在web framework和后端架构中的意义不同。在web framework中是指具体处理GET/POST这些请求之前的一个通用处理（往往是链式调用），比如可以把鉴权、一些日志处理和请求记录放在这里。但在后端架构设计中的middleware则是指类似消息队列、缓存这些在最终数据库之前的中间服务组件。</p>
<p><img src="https://pic3.zhimg.com/80/v2-df43d5baa5c5622f11818b1c0587960a_1440w.jpg" alt="img"></p>
<p>最后这里是想说web framework并不是包治百病，实际上那只是提供了基础功能的一个library，作为开发者则更多需要考虑如何定义配置文件，一些敏感参数如token、密码怎么传进来，开发环境和生产环境的配置如何自动切换，单元测试怎么搞，代码目录怎么组织。有时候我们可以用一些比如Yeoman之类的scaffold工具来自动生成项目代码框架，或者类似django这种也可能自动生成基本目录结构。</p>
<p>下面进入Middleware环节。again，强调一下这里只是根据个人经验和感受谈谈演化过程。</p>
<p><img src="https://pic4.zhimg.com/80/v2-710fac01403a34e623d2ef9c8f88a8a3_1440w.jpg" alt="img"></p>
<p><img src="https://pic3.zhimg.com/80/v2-1ea807b76a16822bd099685837c44e26_1440w.jpg" alt="img"></p>
<p>这一页只是大致讲一下怎么定义中间件middleware。说句题外话，在美国湾区那边提这个概念的很少，而阿里又特别喜欢说中间件，两者相互的交流非常头痛。湾区那边不少google、facebook还有pinterest/uber这些的朋友好几次都在群里问说啥叫中间件。</p>
<p>中间件这个概念很含糊，应该是阿里提出来的，对应于middleware（不过似乎也不是完全对应），可能是因为早期java的EJB那些概念里面比较强调middleware这一点吧（个人猜的）。大致上，如果我们把web后端分为直接处理用户请求的frontend，最后对数据进行持久存储(persistant storage)这两块，那么中间对数据的所有处理环节都可以视为middleware。</p>
<p><img src="https://pic1.zhimg.com/80/v2-590b5a370040ce103147825b1dbc4b00_1440w.jpg" alt="img"></p>
<p>和中间件对应的另一个阿里发明的概念是中台。近一年多阿里的中台概念都相当引人注意，这里对中台不做太多描述。总体来说中台更多是偏向业务和组织架构划分，不能说是一个技术概念，也不是面向开发人员的。而中间件middleware是标准的技术组件服务。</p>
<p>那么我们自然会有一个问题：为什么要用中间件？</p>
<p><img src="https://pic4.zhimg.com/80/v2-d5ee9670feeda1685664ca268939d7ab_1440w.jpg" alt="img"></p>
<p>谈到为什么要用middlware，这里用推荐系统举例。</p>
<p>推荐系统，对数据少用户少的情况下，简单的mysql即可，比如早期论坛的什么top 10热门话题啊，最多回复的话题啊，都可以视为简单的推荐，数据量又不大的情况下，直接select就可以了。</p>
<p>如果是用户推荐的话，用户量不大的情况下，也可以如法炮制，选择同一区域（城市）年龄相当的异性，最后随机挑几个给你，相信世纪佳缘之类的交友网站早期实现也就是类似的模式。</p>
<p><img src="https://pic4.zhimg.com/80/v2-10cc0cc71cb0dd2ad74c5ed7a0284f53_1440w.jpg" alt="img"></p>
<p>那么，如果用户量多了呢？每次都去搜数据库，同时在线用户又多，那对数据库的压力就巨大了。这时候就是引入缓存，memcached、redis就出现了。</p>
<p>简单的做法就是把搜索条件作为key，把结果作为value存入缓存。打个比方你可以把key存为 20:40:beijing:male (20到40岁之间北京的男性），然后把第一次搜索的结果全部打乱shuffle后，存前1000个，10分钟过期，再有人用类似条件搜索，就直接把缓存数据随机挑几个返回。放心，一般来说不会有人10分钟就把1000个用户的资料都看完了，中间偶有重复也没人在意（用世纪佳缘、百合网啥的时候看到过重复的吧）。</p>
<p>不过话又说回来，现代数据库，尤其是类似mongodb/es这些大量占用内存的nosql，已经对经常查询的数据做了缓存，在这之上再加cache，未必真的很有效，这需要case by case去分析了，总之盲目加cache也并不推荐。</p>
<p>加缓存是为了解决访问速度，减轻数据库压力，但是并不提高推荐精准度。如果我们要提高推荐效果呢？在2015年之前机器学习还没那么普及成熟的时候，我们怎么搞呢？</p>
<p><img src="https://pic2.zhimg.com/80/v2-43103b4967ade36bc23a4c588aa93319_1440w.jpg" alt="img"></p>
<p>提高推荐效果，在机器学习之前有两种做法：</p>
<p>- 引入基于lucene的搜索引擎，在搜索的同时通过定制方案实现scoring，比如我可以利用lucene对用户的年龄、性别、地址等进行indexing，但是再返回结果时我再根据用户和查询者两人的具体信息进行关联，自定义返回的score（可以视为推荐相关系数）</p>
<p>- 采用离线批处理。固然可以用hadoop，但是就太杀鸡用牛刀了。常见的是定时批处理任务，按某种规则划分用户群体，对每个群体再做全量计算后把推荐结果写入缓存。这种可以做很繁复准确的计算，虽然慢，但效果往往不错。这种做法也常用在手机游戏的PvP对战列表里面。</p>
<p>这些处理方法对社交网络/手游这类型的其实已经足够了，但是新的业务是不断出现的。随着uber/滴滴/饿了么/美团这些需要实时处理数据的app崛起，作为一个司机，并不想你上线后过几分钟才有客人来吧，你希望你开到一个热点区域，一开机就马上接单。</p>
<p><img src="https://pic2.zhimg.com/80/v2-2c8b89684633800b68fd49df95eb8491_1440w.jpg" alt="img"></p>
<p>所以这种对数据进行实时（近实时）处理的需求也带动了后端体系的大发展，kafka/spark等等流处理大行其道。这时候的后端体系就渐渐引入了消息驱动的模式，所谓消息驱动，就是对新的生产数据会有多个消费者，有的是满足实时计算的需求（比如司机信息需要立刻能够被快速检索到，又不能每次都做全量indexing，就需要用到spark），有的只是为了数据分析，写入类似cassandra这些数据库里，还有的可能是为了生成定时报表，写入到mysql。</p>
<p>大数据的处理一直是业界热点领域。记得2015年硅谷一个朋友就是从一家小公司做php跳去另一家物联网公司做spark相关的工作，之前还很担心玩不转，搞了两年就俨然业界大佬被oracle挖去负责云平台～～～</p>
<p>anyway，这时候对后端体系的要求是一方面能快速满足实时需求，另一方面又能满足各种耗时长的数据分析、data lake存储等等，以及当时渐渐普及的机器学习模型（当时2015年初和几个朋友搞startup，其中一个是walmart lab的机器学习专家，上来就一堆模型，啥数据和用户都还没有就把模型摆上来了，后来搞得非常头痛。当时没有keras/pytorch/tf这些，那堆模型是真心搞不太懂，但是又不敢扔，要靠那东西去包装拿投资的。。。）</p>
<p>但是我们再看上面的图，是不是感觉比较乱呢？各种系统的数据写来写去，是不是有点messy？当公司团队增多，系统复杂度越来越高的时候，我们该怎么梳理？</p>
<p><img src="https://pic1.zhimg.com/80/v2-aa8a341961199f2f90a5ae0d59af5298_1440w.jpg" alt="img"></p>
<p>到了2017之后，前面千奇百怪的后端体系基本上都趋同了。kafka的实时消息队列，spark的流处理（当然现在也可以换成flink，不过大部分应该还是spark），然后后端的存储，基于hive的数据分析查询，然后根据业务的模型训练平台。各个公司反正都差不多这一套，在具体细节上根据业务有所差异，或者有些实力强大的公司会把中间一些环节替换成自己的实现，不过不管怎么千变万化，整体思路基本都一致了。</p>
<p>这里可以看到机器学习和AI模型的引入。个人认为，machine learning的很大一个好处，是简化业务逻辑，简化后台流程，不然一套业务一套实现，各种数据和业务规则很难用一个整体的技术平台来完成。相比前面一页的后台架构，这一页要清晰许多，而且是一个DAG有向无环图的形式，数据流向很明确。我们在下面再来说这个机器学习对业务数据流程的简化。</p>
<p><img src="https://pic4.zhimg.com/80/v2-73b43e91cb1424c626915bc758ea277f_1440w.jpg" alt="img"></p>
<p>在传统后端系统中，业务逻辑其实和数据是客观分离的，逻辑规则和数据之间并不存在客观联系，而是人为主观加入，并没形成闭环，如上图左上所示。而基于机器学习的平台，这个闭环就形成了，从业务数据-&gt;AI模型-&gt;业务逻辑-&gt;影响用户行为-&gt;新的业务数据这个流程是自给自足的。这在很多推荐系统中表现得很明显，通过用户行为数据训练模型，模型对页面信息流进行调整，从而影响用户行为，然后用新的用户行为数据再次调整模型。而在机器学习之前，这些观察工作是交给运营人员去手工猜测调整。</p>
<p>上图右边谈的是机器学习相关后台架构和传统web后台的一些差别，重点是耗时太长，必须异步处理。因此消息驱动机制对机器学习后台是一个必须的设计。</p>
<p><img src="https://pic1.zhimg.com/80/v2-2d917d19d2ac06c55fb6698118d4afbc_1440w.jpg" alt="img"></p>
<p>这页是一些个人的感受，现代的后端数据处理越来越偏向于DAG的形态，Spark不说了，DAG是最大特色；神经网络本身也可以看作是一个DAG（RNN其实也可以看作无数个单向DNN的组合）；tensorflow也是强调其Graph是DAG，另外编程模式上，Reactive编程也很受追捧。</p>
<p>其实DAG的形态重点强调的就是数据本身是immutable（不可修改），只能transform后成为新的数据进入下一环。这个思维其实可以贯穿到现代后台系统设计的每个环节，比如trakcing、analytics、数据表设计、microservice等等，但具体实施还是要case by case了。</p>
<p>无论如何，数据，数据的跟踪tracking，数据的流向，是现代后台系统的核心问题，只有data flow和data pipeline清晰了，整个后台架构才会清楚。</p>
<p>数据库是个非常复杂的领域，在下面对几个基本常用的概念做一些介绍。注意一点是graph database在这里没有提到，因为日常使用较少，相对来说facebook提出的GraphQL倒是个有趣的概念，但也只是在传统db上的一个概念封装。</p>
<p><img src="https://pic1.zhimg.com/80/v2-4143cf5f7956bfbc5b9b8ee29232f8c0_1440w.jpg" alt="img"></p>
<p><img src="https://pic1.zhimg.com/80/v2-68ebb74553bfe58b8e9d45a4cb50e0f0_1440w.jpg" alt="img"></p>
<p>上图是2018年12月初热门数据库的排名，我们可以看到关系数据库RDBMS和NOSQL数据库基本上平分秋色。而NOSQL中实际上又可以分为key-value storage（包括文档型）及column based DB.</p>
<p><img src="https://pic4.zhimg.com/80/v2-fb92fdc74a0f2e118af1b962c467c9cb_1440w.jpg" alt="img"></p>
<p>mysql这个没啥好讲，大概提一下就是。有趣的是曾经看到一篇文章是aws CTO谈的一些内容，其中印象深刻是：如果你的用户还不到100万，就别折腾了，无脑使用mysql吧）</p>
<p>在2015年之前的一个趋势是不少公司使用mysql作为数据存储，但是把indexing放在外部去做。这个思路最早似乎是friendster提出的，后来uber也模仿这种做法设计了自己的数据库schemaless。然而随着postgreSQL的普及(postgreSQL支持对json的索引)，这种做法是否还有意义就值得商榷了。</p>
<p><img src="https://pic3.zhimg.com/80/v2-507e35ce93d80aeb6bebf6848deb3f22_1440w.jpg" alt="img"></p>
<p>nosql最早的使用就是key-value的查找，典型的就是redis。实际上后来的像mongo这些documentbased db也是类似的key value，只是它对document中的内容又做了一次index (inverted index)，用空间换时间来提供查找数据，这也是cs不变的思维。</p>
<p>mongo/elasticsearch收到热捧主要是因为它们的schemaless属性，也就是不需要提前定义数据格式，只要是json就存，还都能根据每个field搜索，这非常方便程序员快速出demo。但是实际上数据量大之后还是要规范数据结构，定义需要indexing的field的。</p>
<p><img src="https://pic3.zhimg.com/80/v2-723236c2176bb28741d4c7f4751ceffa_1440w.jpg" alt="img"></p>
<p>这里提一个比较好玩的开源project nodebb, 这是个node.js开发的论坛系统。在我前几年看到这个的时候它其实只支持redis，然后当时因为一个项目把它改造了让他支持mysql。去年再看的时候发现它同时支持了redis/postres/mongo，如果对比一下同样的功能他如何在这三种db实现的，相信会很有帮助。</p>
<p>稍微谈谈列存储。常见mysql你在select的时候其实往往会把整行都读出来，再在其中挑那么一两个你需要的属性，非常浪费。而mongo这些文件型db，又不支持常见SQL。而列存储DB的好处就是快，不用把一行所有信息读出来，只是按列读取你需要的，对现在的大数据分析特别是OLAP(Online Analytical Processing)来说特别重要。然而据另外的说法，实际上像casssandra/hbase这些并不是真正的列存储，而只是借用了一些概念。这个我也没深入去了解，有兴趣的同学可以自己研究研究。</p>
<p><img src="https://pic4.zhimg.com/80/v2-342b45d16bb14f622614c32f03c1f0c7_1440w.jpg" alt="img"></p>
<p><img src="https://pic2.zhimg.com/80/v2-5244539cea96b21cfd1638d0d6a19665_1440w.jpg" alt="img"></p>
<p>列存储的一个重要领域是时序数据库，物联网用得多。其特色是大量写入，只增不改（不修改数据），但是读的次数相对于很少（想想物联网的特点，随时有数据写入，但是你不会随时都在看你家小米电器的状态。。。）</p>
<p>注意说write/read是正交的。这意思是每次写入是一次一行，而读是按列，加上又不会修改数据，因此各自都能保持极快的速度</p>
<p>下面简单谈一下微服务，大部分直接看PPT就可以了，有几页略微谈一下个人思考。</p>
<p><img src="https://pic4.zhimg.com/80/v2-c1360a57a1ee6ca2f0c53b9ab049437b_1440w.jpg" alt="img"></p>
<p><img src="https://pic2.zhimg.com/80/v2-3d6d3c3952fa3b9d6950534a34b43441_1440w.jpg" alt="img"></p>
<p><img src="https://pic3.zhimg.com/80/v2-fadb7c7b866ae916449075577c808046_1440w.jpg" alt="img"></p>
<p><img src="https://pic1.zhimg.com/80/v2-01201019b017884793f5bdb2bac97dec_1440w.jpg" alt="img"></p>
<p><img src="https://pic1.zhimg.com/80/v2-78b766d7026d9c0ee5707b95a895a9ac_1440w.jpg" alt="img"></p>
<p>上面这页说说，其实微服务所谓的服务发现/name service不要被忽悠觉得是多神奇的东西。最简单的Nginx/Apache这些都能做（域名转向，proxy），或者你要写个name : address的对应关系到db里面也完全可以，再配一个定时healthcheck的服务，最简单的服务发现也就行了。</p>
<p>高级点用到zookeeper/etcd等等，或者SpringCloud全家桶，那只是简化配置，原理都一样。从开发角度来看，微服务的开发并不是难点，难点是微服务的配置和部署。最近一段时间微服务部署也是业界热点，除了全家桶形态的SpringCloud，也可以看看lstio这些开源工具。</p>
<p><img src="https://pic2.zhimg.com/80/v2-d7463a463cd06a7073f3cbda3d518615_1440w.jpg" alt="img"></p>
<p>上图主要大致对比一下，看看从早期的Spring到现在Spring Cloud的变化。想来用过Java Tomcat的朋友都能体会Java这一套Config based development的繁琐，开发的精力很多不是在业务代码上，往往会化不少精力去折腾配置文件。当然，Spring Cloud在这方面简化了不少，不过个人还是不太喜欢java，搞很多复杂的设计模式，封装了又封装。</p>
<p><img src="https://pic2.zhimg.com/80/v2-f9669af0efd0a133fa58ce0a30813c01_1440w.jpg" alt="img"></p>
<p>这里要说并不是微服务解决一切，热门的Python Django尽管有restful-framework，但是它实际上是一个典型的Monolithic体系。对很多核心业务，其实未必要拆开成微服务。</p>
<p>这两者是互补关系，不是替代关系。</p>
<p>下面的docker我就不仔细谈了，PPT基本表达了我想表述的概念，主要意思是</p>
<p>- docker能够简化部署，简化开发，能够在某种程度上让开发环境和产品环境尽量接近</p>
<p>- 不要担心docker的性能，它不是虚拟机，可以看作在server上运行的一个process。</p>
<p><img src="https://pic4.zhimg.com/80/v2-20ce87f5f8ae27a8f4ff0c40e032fa83_1440w.jpg" alt="img"></p>
<p><img src="https://pic4.zhimg.com/80/v2-e15175f3e3a611aa2314df864a915f43_1440w.jpg" alt="img"></p>
<p>上图是描述docker之前开发人员的常见开发环境，首先在自己机器上装一大堆服务，像mysql, redis, tomcat啥的。也有直接在远程服务器安装环境后，多人共同登录远端开发，各自使用一个端口避免冲突…. 实际上这种土法炼钢的形态，在2019年的今天仍然在国内非常普及。</p>
<p>这种形态的后果就是在最后发布到生产环境时，不同开发人员会经历长时间的“联调”，各种端口、权限、脚本、环境设置在生产环境再来一遍…这也是过去运维人员的主要工作。</p>
<p><img src="https://pic3.zhimg.com/80/v2-958630279c89bde1977993b38bd5f33a_1440w.jpg" alt="img"></p>
<p>上一页提到的问题，并不是一定要docker来解决。在这之前，虚拟机VM的出现，以及vagrant这样的工具，都让开发环境的搭建多少轻松了一些。不过思路仍然是把VM作为一个独立服务器使用，只是因为快照、镜像和辅助工具，让环境的配置、统一和迁移更加简单快捷。</p>
<p><img src="https://pic1.zhimg.com/80/v2-34300341c5a98dcf80a857f30e8d5e6c_1440w.jpg" alt="img"></p>
<p>上图是对比程序运行在物理服务器、VM及docker时的资源共享情况，可以看到运行在Docker的应用，并没有比并发运行在物理服务器上占用更多资源。</p>
<p>下图是简单的docker使用，不做赘述。</p>
<p><img src="https://pic3.zhimg.com/80/v2-b33cece5582fe6ce5bb1fb1c48976e6a_1440w.jpg" alt="img"></p>
<p><img src="https://pic2.zhimg.com/80/v2-7ee5f27a7efc94cc0cb2af989bc62a45_1440w.jpg" alt="img"></p>
<p>这一页主要是强调Docker并不等同于虚拟机。虚拟机所占资源是独享的，比如你启动一个VM，分配2G内存，那么这个VM里不管是否运行程序都会占用2G内存。然而如果你启动一个Docker，里面运行一个简单web服务，在不强制指定内存占用情况下，如果没有请求进入，没有额外占用内存，那么这个docker服务对整机的内存占用几乎为0（当然仍然存在一些开销，但主要是根据该程序自身的运行状况而定）。</p>
<p><img src="https://pic3.zhimg.com/80/v2-03fbbb243474fa5bf70b75ab81c0d2ce_1440w.jpg" alt="img"></p>
<p>最后Kubernetes这里大概说说host-pod-container的关系，一个host可以是物理机或者vm，pod不是一个docker，而是可以看作有一个ip的…（不知道怎么形容），总之一个pod可以包括多个container(docker)，pod之中的container可以共享该pod的资源（ip，storage等）。不过现实中似乎大多是一个pod对一个container。</p>
<p>对互联网一些热门概念和演变过程的一个很简略的描述就到这里了，谢谢。</p>

      
      <!-- 打赏 -->
      
    </div>
    <footer class="article-footer">
      <a data-url="https://zkdingme.github.io/2020/11/12/%E4%BB%8E%E6%8A%80%E6%9C%AF%E6%BC%94%E5%8F%98%E7%9A%84%E8%A7%92%E5%BA%A6%E7%9C%8B%E4%BA%92%E8%81%94%E7%BD%91%E5%90%8E%E5%8F%B0%E6%9E%B6%E6%9E%84/" data-id="ckqi0lnoa002cyrj5gnd836rk"
        class="article-share-link">分享</a>
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/%E5%90%8E%E7%AB%AF%E6%9E%B6%E6%9E%84%E6%BC%94%E5%8F%98/" rel="tag">后端架构演变</a></li></ul>

    </footer>

  </div>

  

  
  
  

  

</article>
    
    <article id="post-trojan-proxy-gfw" class="article article-type-post" itemscope
  itemprop="blogPost" data-scroll-reveal>

  <div class="article-inner">
    
    <header class="article-header">
       
<h2 itemprop="name">
  <a class="article-title" href="/2020/11/05/trojan-proxy-gfw/"
    >使用trojan来连接代理服务器</a
  >
</h2>
  

    </header>
    

    
    <div class="article-meta">
      <a href="/2020/11/05/trojan-proxy-gfw/" class="article-date">
  <time datetime="2020-11-04T16:38:15.000Z" itemprop="datePublished">2020-11-05</time>
</a>
      
  <div class="article-category">
    <a class="article-category-link" href="/categories/%E4%BB%A3%E7%90%86/">代理</a>
  </div>

      
      
      
    </div>
    

    

    <div class="article-entry" itemprop="articleBody">
      


      

      
      <p><strong>当配置好代理服务器之后，如何在客户端配置连接代理服务器？本文讲解trojan方案。</strong></p>
<h2 id="1-下载trojan"><a href="#1-下载trojan" class="headerlink" title="1. 下载trojan"></a>1. 下载trojan</h2><p>github地址 <a href="https://github.com/trojan-gfw/trojan/releases" target="_blank" rel="noopener">https://github.com/trojan-gfw/trojan/releases</a></p>
<p>下载之后解压文件结构如下</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">.</span><br><span class="line">├── CONTRIBUTORS.md</span><br><span class="line">├── LICENSE</span><br><span class="line">├── README.md</span><br><span class="line">├── config.json &#x2F;&#x2F; 配置文件</span><br><span class="line">├── examples &#x2F;&#x2F; 配置文件样例</span><br><span class="line">│   ├── client.json-example</span><br><span class="line">│   ├── forward.json-example</span><br><span class="line">│   └── server.json-example</span><br><span class="line">├── start.command</span><br><span class="line">└── trojan &#x2F;&#x2F; 可执行文件</span><br><span class="line"></span><br><span class="line">1 directory, 9 files</span><br></pre></td></tr></table></figure>

<h2 id="2-修改config-json并启动trojan"><a href="#2-修改config-json并启动trojan" class="headerlink" title="2. 修改config.json并启动trojan"></a>2. 修改config.json并启动trojan</h2><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    <span class="attr">"run_type"</span>: <span class="string">"client"</span>, <span class="comment">// 不需要改</span></span><br><span class="line">    <span class="attr">"local_addr"</span>: <span class="string">"127.0.0.1"</span>, <span class="comment">// 不需要改</span></span><br><span class="line">    <span class="attr">"local_port"</span>: <span class="number">1080</span>, <span class="comment">// 可以改也可以不改，建议改成个性端口例如自己生日，防止1080端口被其他进程占用</span></span><br><span class="line">    <span class="attr">"remote_addr"</span>: <span class="string">"example.com"</span>, <span class="comment">// 需要改成自己代理服务器的地址，如果是ip，下面的verify与verify_hostname需要改成false</span></span><br><span class="line">    <span class="attr">"remote_port"</span>: <span class="number">443</span>, <span class="comment">// 需要改成自己代理服务器的监听端口，一般都是443</span></span><br><span class="line">    <span class="attr">"password"</span>: [ <span class="comment">// 需要改成自己代理服务器的密码</span></span><br><span class="line">        <span class="string">"password1"</span> </span><br><span class="line">    ],</span><br><span class="line">    <span class="attr">"log_level"</span>: <span class="number">1</span>,</span><br><span class="line">    <span class="attr">"ssl"</span>: &#123;</span><br><span class="line">        <span class="attr">"verify"</span>: <span class="literal">true</span>, <span class="comment">// remote_addr是ip的话，设置为false</span></span><br><span class="line">        <span class="attr">"verify_hostname"</span>: <span class="literal">true</span>, <span class="comment">// remote_addr是ip的话，设置为false</span></span><br><span class="line">        <span class="comment">// 下面都不要改</span></span><br><span class="line">        <span class="attr">"cert"</span>: <span class="string">""</span>,</span><br><span class="line">        <span class="attr">"cipher"</span>: <span class="string">"ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES128-GCM-SHA256:ECDHE-ECDSA-CHACHA20-POLY1305:ECDHE-RSA-CHACHA20-POLY1305:ECDHE-ECDSA-AES256-GCM-SHA384:ECDHE-RSA-AES256-GCM-SHA384:ECDHE-ECDSA-AES256-SHA:ECDHE-ECDSA-AES128-SHA:ECDHE-RSA-AES128-SHA:ECDHE-RSA-AES256-SHA:DHE-RSA-AES128-SHA:DHE-RSA-AES256-SHA:AES128-SHA:AES256-SHA:DES-CBC3-SHA"</span>,</span><br><span class="line">        <span class="attr">"cipher_tls13"</span>: <span class="string">"TLS_AES_128_GCM_SHA256:TLS_CHACHA20_POLY1305_SHA256:TLS_AES_256_GCM_SHA384"</span>,</span><br><span class="line">        <span class="attr">"sni"</span>: <span class="string">""</span>,</span><br><span class="line">        <span class="attr">"alpn"</span>: [</span><br><span class="line">            <span class="string">"h2"</span>,</span><br><span class="line">            <span class="string">"http/1.1"</span></span><br><span class="line">        ],</span><br><span class="line">        <span class="attr">"reuse_session"</span>: <span class="literal">true</span>,</span><br><span class="line">        <span class="attr">"session_ticket"</span>: <span class="literal">false</span>,</span><br><span class="line">        <span class="attr">"curves"</span>: <span class="string">""</span></span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="attr">"tcp"</span>: &#123;</span><br><span class="line">        <span class="attr">"no_delay"</span>: <span class="literal">true</span>,</span><br><span class="line">        <span class="attr">"keep_alive"</span>: <span class="literal">true</span>,</span><br><span class="line">        <span class="attr">"reuse_port"</span>: <span class="literal">false</span>,</span><br><span class="line">        <span class="attr">"fast_open"</span>: <span class="literal">false</span>,</span><br><span class="line">        <span class="attr">"fast_open_qlen"</span>: <span class="number">20</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>注：mac上查看端口命令为lsof，例如我想将端口设置为1225，就需要执行命令<code>lsof -i:1225</code>，没有输出就说明端口1225未被其他进程占用，可被trojan使用。</p>
<p>config.json改完之后就可以启动trojan了，命令是<code>./trojan -c config.json</code></p>
<h2 id="3-设置全局代理-Mac版本"><a href="#3-设置全局代理-Mac版本" class="headerlink" title="3. 设置全局代理(Mac版本)"></a>3. 设置全局代理(Mac版本)</h2><p>trojan是socks代理，所以我们只要在设置里面修改socks代理设置即可。</p>
<p>打开<strong>设置——网络——WiFi高级——代理——SOCKS代理</strong>，填写config中的local_addr和local_port，应用即可。</p>
<p><img src="trojan-socks.png" alt=""></p>
<p>然后你就可以上网冲浪了。</p>
<p>参考 <a href="https://ssrvps.org/archives/1262" target="_blank" rel="noopener">https://ssrvps.org/archives/1262</a></p>

      
      <!-- 打赏 -->
      
    </div>
    <footer class="article-footer">
      <a data-url="https://zkdingme.github.io/2020/11/05/trojan-proxy-gfw/" data-id="ckqi0lno70020yrj5h72tblgp"
        class="article-share-link">分享</a>
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/trojan/" rel="tag">trojan</a></li></ul>

    </footer>

  </div>

  

  
  
  

  

</article>
    
    <article id="post-Mac-manage-mul-sshkey" class="article article-type-post" itemscope
  itemprop="blogPost" data-scroll-reveal>

  <div class="article-inner">
    
    <header class="article-header">
       
<h2 itemprop="name">
  <a class="article-title" href="/2020/10/24/Mac-manage-mul-sshkey/"
    >Mac管理多个ssh key</a
  >
</h2>
  

    </header>
    

    
    <div class="article-meta">
      <a href="/2020/10/24/Mac-manage-mul-sshkey/" class="article-date">
  <time datetime="2020-10-24T10:54:20.000Z" itemprop="datePublished">2020-10-24</time>
</a>
      
  <div class="article-category">
    <a class="article-category-link" href="/categories/%E5%B7%A5%E5%85%B7/">工具</a>
  </div>

      
      
      
    </div>
    

    

    <div class="article-entry" itemprop="articleBody">
      


      

      
      <p>转载 <a href="https://gitee.com/help/articles/4229" target="_blank" rel="noopener">https://gitee.com/help/articles/4229</a></p>
<blockquote>
<h3 id="背景"><a href="#背景" class="headerlink" title="背景"></a>背景</h3><p>当有多个git账号时，比如：</p>
<p>a. 一个gitee，用于公司内部的工作开发；<br>b. 一个github，用于自己进行一些开发活动；</p>
<h3 id="解决方法"><a href="#解决方法" class="headerlink" title="解决方法"></a>解决方法</h3><ol>
<li>生成一个公司用的SSH-Key</li>
</ol>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ ssh-keygen -t rsa -C &#39;xxxxx@company.com&#39; -f ~&#x2F;.ssh&#x2F;gitee_id_rsa</span><br></pre></td></tr></table></figure>

<ol>
<li>生成一个github用的SSH-Key</li>
</ol>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ ssh-keygen -t rsa -C &#39;xxxxx@qq.com&#39; -f ~&#x2F;.ssh&#x2F;github_id_rsa</span><br></pre></td></tr></table></figure>

<ol>
<li>在 ~/.ssh 目录下新建一个config文件，添加如下内容（其中Host和HostName填写git服务器的域名，IdentityFile指定私钥的路径）</li>
</ol>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"># gitee</span><br><span class="line">Host gitee.com</span><br><span class="line">HostName gitee.com</span><br><span class="line">PreferredAuthentications publickey</span><br><span class="line">IdentityFile ~&#x2F;.ssh&#x2F;gitee_id_rsa</span><br><span class="line"># github</span><br><span class="line">Host github.com</span><br><span class="line">HostName github.com</span><br><span class="line">PreferredAuthentications publickey</span><br><span class="line">IdentityFile ~&#x2F;.ssh&#x2F;github_id_rsa</span><br></pre></td></tr></table></figure>

<p>4.用ssh命令分别测试</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ ssh -T git@gitee.com</span><br><span class="line">$ ssh -T git@github.com</span><br></pre></td></tr></table></figure>
</blockquote>

      
      <!-- 打赏 -->
      
    </div>
    <footer class="article-footer">
      <a data-url="https://zkdingme.github.io/2020/10/24/Mac-manage-mul-sshkey/" data-id="ckqi0lnnr000nyrj55q8idot4"
        class="article-share-link">分享</a>
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/%E5%8D%95%E6%9C%BA%E7%AE%A1%E7%90%86%E5%A4%9A%E4%B8%AAssh-key/" rel="tag">单机管理多个ssh-key</a></li></ul>

    </footer>

  </div>

  

  
  
  

  

</article>
    
    <article id="post-发现异常" class="article article-type-post" itemscope
  itemprop="blogPost" data-scroll-reveal>

  <div class="article-inner">
    
    <header class="article-header">
       
<h2 itemprop="name">
  <a class="article-title" href="/2020/10/12/%E5%8F%91%E7%8E%B0%E5%BC%82%E5%B8%B8/"
    >发现异常</a
  >
</h2>
  

    </header>
    

    
    <div class="article-meta">
      <a href="/2020/10/12/%E5%8F%91%E7%8E%B0%E5%BC%82%E5%B8%B8/" class="article-date">
  <time datetime="2020-10-12T02:56:21.000Z" itemprop="datePublished">2020-10-12</time>
</a>
      
  <div class="article-category">
    <a class="article-category-link" href="/categories/%E6%95%B0%E6%8D%AE%E6%8C%96%E6%8E%98/">数据挖掘</a>
  </div>

      
      
      
    </div>
    

    

    <div class="article-entry" itemprop="articleBody">
      


      

      
      <ul>
<li>根据已有异常关联未发现的异常<br>ip在黑名单的用户的其他特征像wifi数量、设备指纹和登陆时间段都可能是异常</li>
<li>随时间变化不稳定<br>正常用户的属性随时间变化都是稳定的，异常用户是不稳定的</li>
<li>聚类<br>正常人聚类在一起一大团，异常人聚类一小团</li>
</ul>

      
      <!-- 打赏 -->
      
    </div>
    <footer class="article-footer">
      <a data-url="https://zkdingme.github.io/2020/10/12/%E5%8F%91%E7%8E%B0%E5%BC%82%E5%B8%B8/" data-id="ckqi0lnod002oyrj5ataa8e2h"
        class="article-share-link">分享</a>
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/%E5%8F%91%E7%8E%B0%E5%BC%82%E5%B8%B8/" rel="tag">发现异常</a></li></ul>

    </footer>

  </div>

  

  
  
  

  

</article>
    
    <article id="post-Android-Dumpdex" class="article article-type-post" itemscope
  itemprop="blogPost" data-scroll-reveal>

  <div class="article-inner">
    
    <header class="article-header">
       
<h2 itemprop="name">
  <a class="article-title" href="/2020/09/30/Android-Dumpdex/"
    >Android 壳的背景知识</a
  >
</h2>
  

    </header>
    

    
    <div class="article-meta">
      <a href="/2020/09/30/Android-Dumpdex/" class="article-date">
  <time datetime="2020-09-30T03:35:48.000Z" itemprop="datePublished">2020-09-30</time>
</a>
      
  <div class="article-category">
    <a class="article-category-link" href="/categories/Android/">Android</a>
  </div>

      
      
      
    </div>
    

    

    <div class="article-entry" itemprop="articleBody">
      


      

      
      <h2 id="背景知识"><a href="#背景知识" class="headerlink" title="背景知识"></a>背景知识</h2><p>壳是什么，为什么要脱壳，怎么脱壳？</p>
<p>壳是终端攻防的产物，最早在PC时代就出现了。最早是因为黑产会反编译得到应用程序的源码，然后魔改后重打包再投放到市场上去，这就是所谓的盗版软件，或者就直接在源码里面找到程序的漏洞例如支付漏洞，然后搞破坏。开发者们当然注意到了这些严重的漏洞，所以他们就给程序加壳来抵御黑产的攻击。壳这个名字就很形象的描述了这套防御机制，简单说就是在源码外面套了一层壳保护源码，黑产们想要获得源码需要先打破这层壳或者越过这层壳。加壳显著提高了黑产们获取源码的难度，缓解了之前源码裸奔的尴尬场景。当然攻防是S形向前发展的，当开发者们加壳之后，黑产们很快就研究出了破壳或者说脱壳的方法，开发者们也紧跟着推出了新一代的壳，就这样道高一尺魔高一丈然后又魔高一尺道高一丈相爱相杀。总体来说，壳这个机制还是很有效的，虽然还是存在被脱壳的可能，但是在一次又一次的攻防中，脱壳的难度已经被拉高了太多，这个门槛已经比较高，还在坚持的黑产玩家已经不多了。当然壳也有其不好的一面，首先就是对性能的影响，壳太厚势必会拉低性能，某宝加壳后性能拉低了40-50倍，这还是不断优化后的结果。其次就是其他方面的安全性会降低，安全是一条链，这条链上有很多节点，终端app只是其中一个节点，这条链上还有很多别的节点，任何一颗节点被攻破都会造成大大小小的损失。你在终端壳上投入巨大势必其他方面投入就小了，黑产发现攻你app太难了，肯定就转头去试试你的服务器了。</p>
<p>移动端兴起之后，这套玩法也传承了下来，早期市场上充斥着大量的盗版软件，尤其是游戏领域，全是内购破解的。现在脱壳也还是很火，比较热门的就是脱一些短视频平台的壳，逆向出网络协议，然后写脚本刷关注、刷播放量。</p>
<h2 id="如何脱壳"><a href="#如何脱壳" class="headerlink" title="如何脱壳"></a>如何脱壳</h2><p>宗旨是无论你如何加壳，代码总归是要运行的，总归是要明文出现在内存里面的，脱壳就是在适当的时机把内存里面的代码dump出来。Android领域脱壳方案有很多种，像Fart、Youpk、DexHunter等，具体可在看雪平台搜索相应脱壳方案与其原理，这里不做描述。笔者只尝试过原始的ida动态定位dex地址并dump内存方案、Fart方案和基于frida的方案，在当时确实能dump出源码，还是挺有趣的。</p>
<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>我个人并不看好壳的未来，首先是对性能影响太大，其次是Android上的壳发展到现在已经很难破了例如VMP，再继续搞新壳难度太大也没必要，最后是现在的大势是一切上云，云手机是未来(手机算力不如服务器，现在美国还卡芯片，之后会专门讲一期云手机)，云手机就意味着大家之后的手机就是个显示屏+遥控器，app运行在服务器上做计算和渲染，到时候黑产根本就拿不到apk，跟别提脱壳了。</p>
<p>不过就算壳没了，黑产也不会消失，攻防这场战争是无止尽的。</p>

      
      <!-- 打赏 -->
      
    </div>
    <footer class="article-footer">
      <a data-url="https://zkdingme.github.io/2020/09/30/Android-Dumpdex/" data-id="ckqi0lnn10000yrj55mg8ann7"
        class="article-share-link">分享</a>
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/%E8%84%B1%E5%A3%B3/" rel="tag">脱壳</a></li></ul>

    </footer>

  </div>

  

  
  
  

  

</article>
    
    <article id="post-android-type3-error" class="article article-type-post" itemscope
  itemprop="blogPost" data-scroll-reveal>

  <div class="article-inner">
    
    <header class="article-header">
       
<h2 itemprop="name">
  <a class="article-title" href="/2020/09/29/android-type3-error/"
    >Error type 3 Error Activity class {} does not exist</a
  >
</h2>
  

    </header>
    

    
    <div class="article-meta">
      <a href="/2020/09/29/android-type3-error/" class="article-date">
  <time datetime="2020-09-28T16:20:48.000Z" itemprop="datePublished">2020-09-29</time>
</a>
      
  <div class="article-category">
    <a class="article-category-link" href="/categories/Android/">Android</a>
  </div>

      
      
      
    </div>
    

    

    <div class="article-entry" itemprop="articleBody">
      


      

      
      <p>Android Studio debug 安装 app 到手机上时，有时会安装失败，报错如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">09&#x2F;29 00:22:11: Launching app</span><br><span class="line">$ adb shell am start -n &quot;me.zkding.btdemo&#x2F;me.zkding.btdemo.activity.BluetoothChat&quot; -a android.intent.action.MAIN -c android.intent.category.LAUNCHER</span><br><span class="line">Error while executing: am start -n &quot;me.zkding.btdemo&#x2F;me.zkding.btdemo.activity.BluetoothChat&quot; -a android.intent.action.MAIN -c android.intent.category.LAUNCHER</span><br><span class="line">Starting: Intent &#123; act&#x3D;android.intent.action.MAIN cat&#x3D;[android.intent.category.LAUNCHER] cmp&#x3D;me.zkding.btdemo&#x2F;.activity.BluetoothChat &#125;</span><br><span class="line">Error type 3</span><br><span class="line">Error: Activity class &#123;me.zkding.btdemo&#x2F;me.zkding.btdemo.activity.BluetoothChat&#125; does not exist.</span><br><span class="line"></span><br><span class="line">Error while Launching activity</span><br></pre></td></tr></table></figure>

<p>这个问题StackOverflow上就有人问过，也有人给出了<a href="https://stackoverflow.com/questions/20915266/error-type-3-error-activity-class-does-not-exist" target="_blank" rel="noopener">建议</a>, 但对我都不work。</p>
<p>苦恼许久我才发现，原来是我之前debug时候装了一个apk在手机上，然后卸载的时候是手动卸载的(华为长按卸载)，然后再次安装同样的debug包就会报这个错。解决方法是 <code>adb uninstall me.zkding.btdemo</code> ，然后再安装就可以了。应该是手动卸载有什么东西没卸载干净，不过我暂时没时间细究，留个TODO。</p>

      
      <!-- 打赏 -->
      
    </div>
    <footer class="article-footer">
      <a data-url="https://zkdingme.github.io/2020/09/29/android-type3-error/" data-id="ckqi0lnnw0012yrj54nzz85bw"
        class="article-share-link">分享</a>
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Debug/" rel="tag">Debug</a></li></ul>

    </footer>

  </div>

  

  
  
  

  

</article>
    
    <article id="post-ssh-remote-tunnel" class="article article-type-post" itemscope
  itemprop="blogPost" data-scroll-reveal>

  <div class="article-inner">
    
    <header class="article-header">
       
<h2 itemprop="name">
  <a class="article-title" href="/2020/09/26/ssh-remote-tunnel/"
    >ssh remote tunnel 介绍</a
  >
</h2>
  

    </header>
    

    
    <div class="article-meta">
      <a href="/2020/09/26/ssh-remote-tunnel/" class="article-date">
  <time datetime="2020-09-26T12:53:24.000Z" itemprop="datePublished">2020-09-26</time>
</a>
      
  <div class="article-category">
    <a class="article-category-link" href="/categories/%E7%BD%91%E7%BB%9C/">网络</a>
  </div>

      
      
      
    </div>
    

    

    <div class="article-entry" itemprop="articleBody">
      


      

      
      <p><strong>转载自 <a href="https://blog.csdn.net/blade2001/article/details/8877250" target="_blank" rel="noopener">https://blog.csdn.net/blade2001/article/details/8877250</a></strong></p>
<p>SSH的的Port Forward，中文可以称为端口转发，是SSH的一项非常重要的功能。它可以建立一条安全的SSH通道，并把任意的TCP连接放到这条通道中。下面仔细就仔细讨论SSH的这种非常有用的功能。</p>
<p>SSH Tunnel有三种，分别是本地Local（ssh -NfL），远程Remote（ssh -NfR），动态Dynamic（ssh -NfD）。（含义参考<a href="http://linux.die.net/man/1/ssh" target="_blank" rel="noopener">man ssh</a>）</p>
<p>说明：在我们举例说明用法之前，先假设你有一台SSH机器，它的IP是a.b.c.d。</p>
<p>1：本地Local（ssh -NfL）</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ssh -L &lt;local port&gt;:&lt;remote host&gt;:&lt;remote port&gt; &lt;SSH hostname&gt;</span><br></pre></td></tr></table></figure>

<p>ssh -NfL a.b.c.d : 1234 : <a href="http://www.google.com" target="_blank" rel="noopener">www.google.com</a> : 80  a.b.c.d</p>
<p>此时，在浏览器里键入：<a href="http://a.b.c.d:1234" target="_blank" rel="noopener">http://a.b.c.d:1234</a> 就会看到Google的页面了。</p>
<p>在绑定1234端口的时候，可以省略前面的ip，如此一来，1234端口就仅仅绑定在localhost地址上，更安全：</p>
<p>ssh -NfL 1234 : <a href="http://www.google.com" target="_blank" rel="noopener">www.google.com</a> : 80  a.b.c.d</p>
<p>此时浏览的话就要在a.b.c.d机器上使用<a href="http://localhost:1234" target="_blank" rel="noopener">http://localhost:1234</a> 了。</p>
<p><strong><em>\</em>何时使用本地Tunnel？\</strong></p>
<p>*<em>比如说你在本地访问不了某个网络服务（如<a href="http://www.google.com" target="_blank" rel="noopener">www.google.com</a> ，而有一台机器（如：a.b.c.d）可以，那么你就可以通过这台机器来访问。***</em></p>
<p>2：远程Remote（ssh -NfR）</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ssh -R &lt;local port&gt;:&lt;remote host&gt;:&lt;remote port&gt; &lt;SSH hostname&gt;</span><br></pre></td></tr></table></figure>

<p>在需要被访问的内网机器上运行： ssh -NfR 1234 : localhost : 22  a.b.c.d</p>
<p>登录到a.b.c.d机器，使用如下命令连接内网机器：</p>
<p>ssh -p 1234  localhost</p>
<p>需要注意的是上下两个命令里的localhost不是同一台。这时你会发现自己已经连上最开始命令里的localhost机器了，也就是执行“ssh -NfR”的那台机器。</p>
<p><strong><em>\</em>何时使用远程Tunnel？\</strong></p>
<p>*<em>比如当你下班回家后就访问不了公司内网的机器了，遇到这种情况可以事先在公司内网的机器上执行远程Tunnel，连上一台公司外网的机器，等你下班回家后 就可以通过公司外网的机器去访问公司内网的机器了。***</em></p>
<p>3：动态Dynamic（ssh -NfD）<strong>-\</strong>Socket代理****</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ssh -D</span><br></pre></td></tr></table></figure>

<p>ssh -NfD 1234  a.b.c.d</p>
<p>a.b.c.c 是server 地址</p>
<p>如此一来就建立了一台Socket代理机器，接着在浏览器上设置Socket代理：地址是localhost，端口是1234，从此以后，你的访问都是加 密的了！你可以通过访问 <a href="http://www.whatismyip.com/" target="_blank" rel="noopener">WhatIsMyIP</a> 来 确认自己现在的IP，看看是不是已经变成a.b.c.d了。</p>
<p>测试阶段，也可以把端口绑定在外网地址上，如此一来，你在浏览器上就可以使用外网地址设置Socket代理，但这仅限于测试，否则，你的机器就不安全了， 随时可能成为肉鸡。对于Windows用户来说，如果讨厌命令行，还可以使用MyEnTunnel来实现同样的功能，配合Firefox的 FoxyPorxy，基本就无敌了，至于具体的配置方法，小崔已经写好了： <a href="http://fendou.org/2010/01/19/firefox-foxyproxy-ssh/" target="_blank" rel="noopener">使用Firefox+foxyProxy+SSH翻山越岭</a> 。如果你使用的是Chrome的话，则可以选择 Proxy Switchy!来实现同样的效果，恕不多言。</p>

      
      <!-- 打赏 -->
      
    </div>
    <footer class="article-footer">
      <a data-url="https://zkdingme.github.io/2020/09/26/ssh-remote-tunnel/" data-id="ckqi0lno80024yrj5dlh4gbz2"
        class="article-share-link">分享</a>
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/ssh-tunnel/" rel="tag">ssh tunnel</a></li></ul>

    </footer>

  </div>

  

  
  
  

  

</article>
    
    <article id="post-batch为啥快" class="article article-type-post" itemscope
  itemprop="blogPost" data-scroll-reveal>

  <div class="article-inner">
    
    <header class="article-header">
       
<h2 itemprop="name">
  <a class="article-title" href="/2020/09/26/batch%E4%B8%BA%E5%95%A5%E5%BF%AB/"
    >batch为啥快</a
  >
</h2>
  

    </header>
    

    
    <div class="article-meta">
      <a href="/2020/09/26/batch%E4%B8%BA%E5%95%A5%E5%BF%AB/" class="article-date">
  <time datetime="2020-09-26T09:54:30.000Z" itemprop="datePublished">2020-09-26</time>
</a>
      
  <div class="article-category">
    <a class="article-category-link" href="/categories/%E8%AE%A1%E7%AE%97%E6%9C%BA%E5%9F%BA%E7%A1%80%E6%9D%82%E8%B0%88/">计算机基础杂谈</a>
  </div>

      
      
      
    </div>
    

    

    <div class="article-entry" itemprop="articleBody">
      


      

      
      <p>batch其实不一定快，所谓快，一个是throughput，一个是latency。batch的throughput肯定更高，但是latency也更高，所以这也算是个tradeoff。</p>
<p>那batch的throughput为什么会更高呢？简单说，batch读的时候cache hit率会更高，batch写的时候寻址会更快，也许会写到同一个block里面。</p>

      
      <!-- 打赏 -->
      
    </div>
    <footer class="article-footer">
      <a data-url="https://zkdingme.github.io/2020/09/26/batch%E4%B8%BA%E5%95%A5%E5%BF%AB/" data-id="ckqi0lnnz0015yrj56r92av7e"
        class="article-share-link">分享</a>
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/%E6%89%B9%E5%A4%84%E7%90%86/" rel="tag">批处理</a></li></ul>

    </footer>

  </div>

  

  
  
  

  

</article>
    
    <article id="post-DeFi" class="article article-type-post" itemscope
  itemprop="blogPost" data-scroll-reveal>

  <div class="article-inner">
    
    <header class="article-header">
       
<h2 itemprop="name">
  <a class="article-title" href="/2020/09/15/DeFi/"
    >DeFi</a
  >
</h2>
  

    </header>
    

    
    <div class="article-meta">
      <a href="/2020/09/15/DeFi/" class="article-date">
  <time datetime="2020-09-15T04:21:17.000Z" itemprop="datePublished">2020-09-15</time>
</a>
      
  <div class="article-category">
    <a class="article-category-link" href="/categories/%E5%8C%BA%E5%9D%97%E9%93%BE/">区块链</a>
  </div>

      
      
      
    </div>
    

    

    <div class="article-entry" itemprop="articleBody">
      


      

      
      <h2 id="DeFi是什么"><a href="#DeFi是什么" class="headerlink" title="DeFi是什么"></a>DeFi是什么</h2><p>去中心化的金融，可以理解为区块链领域的金融。举例说，我持有100万人民币，但是暂时不需要花，那我肯定选择去把钱存银行吃利息或者去买点股票基金啥的，让钱生点钱，一年后我的100万就变成了110万，我很开心。那在区块链领域，我持有100个BTC，除了等BTC从1万美元升值到2万美元外，并没有像现实社会中理财的方式，简单说，我的100BTC一年后还是100个BTC，不会变成110个BTC。基于这个需求，DeFi就出现了。</p>
<p>DeFi只是一个概念，落到实处就是一个一个具体的DeFI项目。什么是DeFi项目，对比现实社会就是债券、股票、基金、银行存钱这些理财项目，本质上就是你投资他们，他们赚钱之后给你返利。我简单举三个例子说明一下：</p>
<ul>
<li>项目A，年化10%。区块链领域一家大的矿池说，我想扩张，做东半球最大的矿池，但是我现在钱不够，大家给我投点钱，我去扩张，等我成了东半球最大的矿池转了大钱，我分你钱。</li>
<li>项目B，年化50%。区块链领域的一家金融机构，专门炒币，当BTC低的时候买，高的时候抛。现在这家金融机构判断BTC已经到了底部，准备大举抄底，但是现在钱不够，只能抄一点，等之后涨起来估计也就赚个100W。现在他们说，大家借我点钱，我抄个底，等BTC涨上去我卖掉再把钱还给大家，还给大家一笔可观的分红。</li>
<li>项目C，年化5%。区块链领域的一家基金管理公司，对比现实社会中易方达、工银瑞信等。他们说，老乡们，外面的DeFi项目都是骗子，你别看项目A，项目B年化都10个点，50个点，他们风险很大的。你想想项目A万一扩张失败倒闭了，项目BTC一直下降不涨了，你的钱就没了呀。外面的DeFi项目那么多，有好有坏，老乡们哪有那么多精力去挑选一个高收益低风险的，不如把钱交给我，我全职帮你管理，我帮你们挑选合适的项目，帮你们理财，你们给我点工资就好，我给你们打工。</li>
</ul>
<p>总结一下，DeFi就是区块链领域的理财项目。</p>
<h2 id="怎么靠DeFi项目赚钱"><a href="#怎么靠DeFi项目赚钱" class="headerlink" title="怎么靠DeFi项目赚钱"></a>怎么靠DeFi项目赚钱</h2><p>这要看你的身份。</p>
<p><strong>你是个投资者</strong></p>
<p>这没什么好说的，选一个靠谱的DeFi项目，把钱投进去就可以吃利息了。</p>
<p><strong>你是个创业者</strong></p>
<p>做一个基金管理公司，参考YFI/YFII/SUSHI。</p>
<p><a href="https://dfi.money/#/vault" target="_blank" rel="noopener">https://dfi.money/#/vault</a></p>
<p><a href="https://docs.yfii.finance/#/zh-cn/tuts" target="_blank" rel="noopener">https://docs.yfii.finance/#/zh-cn/tuts</a></p>
<p>大概就是fork一个这个池 <a href="https://docs.qq.com/doc/DUlpka0FXeGVMbkhm" target="_blank" rel="noopener">https://docs.qq.com/doc/DUlpka0FXeGVMbkhm</a></p>
<p>反正核心就简化用户投资的流程，不需要用户挑选DeFi项目</p>

      
      <!-- 打赏 -->
      
    </div>
    <footer class="article-footer">
      <a data-url="https://zkdingme.github.io/2020/09/15/DeFi/" data-id="ckqi0lnng000gyrj5fjk826pg"
        class="article-share-link">分享</a>
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/DeFi/" rel="tag">DeFi</a></li></ul>

    </footer>

  </div>

  

  
  
  

  

</article>
    
    <article id="post-bloom-filter-kiss" class="article article-type-post" itemscope
  itemprop="blogPost" data-scroll-reveal>

  <div class="article-inner">
    
    <header class="article-header">
       
<h2 itemprop="name">
  <a class="article-title" href="/2020/08/18/bloom-filter-kiss/"
    >11个问题帮你了解bloom filter</a
  >
</h2>
  

    </header>
    

    
    <div class="article-meta">
      <a href="/2020/08/18/bloom-filter-kiss/" class="article-date">
  <time datetime="2020-08-18T06:03:35.000Z" itemprop="datePublished">2020-08-18</time>
</a>
      
  <div class="article-category">
    <a class="article-category-link" href="/categories/%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84/">数据结构</a>
  </div>

      
      
      
    </div>
    

    

    <div class="article-entry" itemprop="articleBody">
      


      

      
      <h3 id="1-bloom-filter是用来解决什么问题的"><a href="#1-bloom-filter是用来解决什么问题的" class="headerlink" title="1. bloom filter是用来解决什么问题的"></a>1. bloom filter是用来解决什么问题的</h3><p>快速查询元素a是否在集合A={a1,a2,..,an}里面，例如判断一个用户是否在黑名单中。</p>
<h3 id="2-简述bloom-filter的工作原理"><a href="#2-简述bloom-filter的工作原理" class="headerlink" title="2. 简述bloom filter的工作原理"></a>2. 简述bloom filter的工作原理</h3><ol>
<li>构建一个长度为m的bit array，初始化其中所有bit为0。</li>
<li>将集合A={a1,a2,..,an}中所有元素插入到bit array中。插入元素ai时，用k个hash函数算出k个位置，将对应位置的bit置为1。</li>
<li>为了查询元素a是否在集合A={a1,a2,..,an}中。同样用k个hash函数计算出a在bit array中的k个位置，如果这k个位置不全为1则a<strong>一定不在</strong>集合A中；如果全为1，则说明a<strong>可能</strong>在集合A中。这里存在false positive，因为对应k个位置的bit全为1可能是其他元素置的。</li>
</ol>
<p>如下图所示，构建了一个长度为16的bit array，将集合A中元素用3个hash函数计算位置并将对应bit置为1。查询a1时，同样计算3次hash发现对应位置bit全为1，因此判定a1可能在A中。对实际不在A的两个元素x、y，同样计算3次hash。x对应的3个bit全为1，bloom filter判定x可能在A中，但实际上x不在A中，x对应的三个bit是被a2、a3置为1的，这就造成了bloom filter的false positive；y对应的3个bit中有2个bit为0，因此bloom filter判定y一定不在A中。bloom filter不存在false negative，可以用反证法证明。如果存在false negative z，说明z实际在A中，那么z对应的bit全为1，那么bloom filter判断的结果应该是z可能在A中而不是不在，因此矛盾。</p>
<p><img src="bf.svg" alt=""></p>
<h3 id="3-Bloom-filter会有false-positive吗"><a href="#3-Bloom-filter会有false-positive吗" class="headerlink" title="3. Bloom filter会有false positive吗"></a>3. Bloom filter会有false positive吗</h3><p>会有，原因见问题2。</p>
<h3 id="4-Bloom-filter会有false-negative吗"><a href="#4-Bloom-filter会有false-negative吗" class="headerlink" title="4. Bloom filter会有false negative吗"></a>4. Bloom filter会有false negative吗</h3><p>不会有，原因见问题。</p>
<h3 id="5-bloom的误判率受什么影响"><a href="#5-bloom的误判率受什么影响" class="headerlink" title="5. bloom的误判率受什么影响"></a>5. bloom的误判率受什么影响</h3><p>最优k时，有$${\displaystyle \ln \varepsilon =-{\frac {m}{n}}\left(\ln 2\right)^{2}.}$$</p>
<p>显然，m越大，n越小，误判率越低。</p>
<h3 id="6-bit-array的大小m如何确定"><a href="#6-bit-array的大小m如何确定" class="headerlink" title="6. bit array的大小m如何确定"></a>6. bit array的大小m如何确定</h3><p>$$ m=-{\frac {n\ln \varepsilon }{(\ln 2)^{2}}} $$</p>
<p>其中n为数据集A的size，$\varepsilon$为指定的false positive possibility</p>
<table>
<thead>
<tr>
<th>$ \varepsilon $</th>
<th>m/n</th>
</tr>
</thead>
<tbody><tr>
<td>1/10</td>
<td>4.79</td>
</tr>
<tr>
<td>1/100</td>
<td>9.59</td>
</tr>
<tr>
<td>1/1000</td>
<td>14.38</td>
</tr>
<tr>
<td>1/10000</td>
<td>19.17</td>
</tr>
<tr>
<td>1/100000</td>
<td>23.96</td>
</tr>
<tr>
<td>1/1000000</td>
<td>28.76</td>
</tr>
<tr>
<td>1/10000000</td>
<td>33.55</td>
</tr>
<tr>
<td>1/100000000</td>
<td>38.34</td>
</tr>
<tr>
<td>1/1000000000</td>
<td>43.13</td>
</tr>
</tbody></table>
<p>可以看到 当误判率降低到10亿分之一时，bit array的size m也只是数据集长度的43倍</p>
<h3 id="7-hash轮数k如何确定"><a href="#7-hash轮数k如何确定" class="headerlink" title="7. hash轮数k如何确定"></a>7. hash轮数k如何确定</h3><p>$$k={\frac {m}{n}}\ln 2$$</p>
<p>其中m为bit array的size，n为数据集A的size</p>
<h3 id="8-hash轮数k与数据集A中单个数据的长度l有没有关系"><a href="#8-hash轮数k与数据集A中单个数据的长度l有没有关系" class="headerlink" title="8. hash轮数k与数据集A中单个数据的长度l有没有关系"></a>8. hash轮数k与数据集A中单个数据的长度l有没有关系</h3><p>有关系。hash轮数代表需要多少个bit来表示单个数据，在bloom filter中，表示单个数据需要k个bit。如果单个数据的长度l小于k个bit，那这种情况下用bloom filter就会造成空间的浪费，不划算。实际情况下，1%的false positive rate，9.6个bit就可以表示单个数据数据；0.1%的false positive rate，14.4个bit可以表示单个数据。这时候如果单个数据的长度小于14.4个bit，用bloom filter从空间开销上来说，就不划算了。</p>
<h3 id="9-对于查询一个元素是否在一个集合中这个问题，除了bloom-filter，你觉得还有什么解决方案，bloom-filter相比他们有什么优势有什么缺点"><a href="#9-对于查询一个元素是否在一个集合中这个问题，除了bloom-filter，你觉得还有什么解决方案，bloom-filter相比他们有什么优势有什么缺点" class="headerlink" title="9. 对于查询一个元素是否在一个集合中这个问题，除了bloom filter，你觉得还有什么解决方案，bloom filter相比他们有什么优势有什么缺点"></a>9. 对于查询一个元素是否在一个集合中这个问题，除了bloom filter，你觉得还有什么解决方案，bloom filter相比他们有什么优势有什么缺点</h3><p>我们需要考虑空间开销与查询时间开销以及正确率。空间开销的话，其他数据结构像数组、链表、平衡二叉搜索树、哈希表等都要存储源数据，相比于只需要一个bit array的bloom filter来说，肯定是不如的。时间开销的话，bloom filter的时间复杂度为O(k)，上述几种方案查询时间复杂度最优的是哈希表O(1)。因此我们对比一下哈希表与bloom filter。</p>
<p>主要对比三个方面：</p>
<ul>
<li>存储10W条大小为50byte的string需要多少空间</li>
<li>查询10W条相同数据与10万条不同数据需要多少时间</li>
<li>查询上面20W条数据正确率如何</li>
</ul>
<p>效果如下：</p>
<table>
<thead>
<tr>
<th></th>
<th>哈希表</th>
<th>bf(fpp=0.001)</th>
<th>bf(fpp=0.00001)</th>
<th>bf(fpp=0.0001)</th>
</tr>
</thead>
<tbody><tr>
<td>空间大小</td>
<td>12.44M</td>
<td>176K</td>
<td>293K</td>
<td>352K</td>
</tr>
<tr>
<td>查询时间</td>
<td>21ms</td>
<td>70ms</td>
<td>103ms</td>
<td>90ms</td>
</tr>
<tr>
<td>正确率(FP)</td>
<td>0</td>
<td>108</td>
<td>1</td>
<td>0</td>
</tr>
<tr>
<td>正确率(FN)</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
</tr>
</tbody></table>
<p>可以看到bloom filter空间开销是哈希表的1/72～1/36，但是时间开销是哈希表的3～5倍。正确率方面bloom filter是有False Positive的。总结来说，bloom filter相比于其他解决方案的优势在于时间开销与空间开销都很低，适用于数据集特别大的查询场景；劣势在于有False Positive。</p>
<h3 id="10-Bloom-filter除了用来高效查询之外还可以用来干嘛"><a href="#10-Bloom-filter除了用来高效查询之外还可以用来干嘛" class="headerlink" title="10. Bloom filter除了用来高效查询之外还可以用来干嘛"></a>10. Bloom filter除了用来高效查询之外还可以用来干嘛</h3><ul>
<li>高效安全存储。bloom filter只需要10个bit就可以表示数据，对于一些不需要知道源数据或者源数据较为敏感的存储场景，可以使用bloom filter进行存储。例如门禁设备，存储所有人的指纹或者瞳纹在设备内部不是很安全，万一设备被盗了，所有人的指纹瞳纹就被泄露了，这种情况下，用bloom filter将所有人的指纹瞳纹存储为一个bit array就很合适。</li>
<li>复杂查询。bloom filter支持将bit array做交集或者并集后再进行查询。</li>
</ul>
<h3 id="11-Bloom-filter可以怎么被用在你的项目上"><a href="#11-Bloom-filter可以怎么被用在你的项目上" class="headerlink" title="11. Bloom filter可以怎么被用在你的项目上"></a>11. Bloom filter可以怎么被用在你的项目上</h3><p>略</p>
<h3 id="12-Bloom-filter是谁在什么时候发明的"><a href="#12-Bloom-filter是谁在什么时候发明的" class="headerlink" title="12. Bloom filter是谁在什么时候发明的"></a>12. Bloom filter是谁在什么时候发明的</h3><p>1970 <a href="https://en.wikipedia.org/w/index.php?title=Burton_Howard_Bloom&action=edit&redlink=1" target="_blank" rel="noopener">Burton Howard Bloom</a></p>
<h3 id="13-Bloom-filter-在Java、Python与Redis中的使用"><a href="#13-Bloom-filter-在Java、Python与Redis中的使用" class="headerlink" title="13. Bloom filter 在Java、Python与Redis中的使用"></a>13. Bloom filter 在Java、Python与Redis中的使用</h3><p><strong>Java</strong> </p>
<p>依赖库</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.google.guava<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>guava<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>29.0-jre<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>



<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> com.google.common.base.Charsets;</span><br><span class="line"><span class="keyword">import</span> com.google.common.hash.BloomFilter;</span><br><span class="line"><span class="keyword">import</span> com.google.common.hash.Funnels;</span><br><span class="line"><span class="keyword">import</span> org.apache.lucene.util.RamUsageEstimator;    </span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">myBF</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="comment">// public static &lt;T&gt; BloomFilter&lt;T&gt; create(Funnel&lt;? super T&gt; funnel, int expectedInsertions, double fpp) </span></span><br><span class="line">        BloomFilter&lt;String&gt; bf = BloomFilter.create(Funnels.stringFunnel(Charsets.UTF_8), <span class="number">100000</span>,<span class="number">0.000001</span>);</span><br><span class="line">        ArrayList&lt;String&gt; li = readInstallid(<span class="string">"/Users/dingzhenkai/Downloads/i10W.txt"</span>);</span><br><span class="line">        ArrayList&lt;String&gt; lin = readInstallid(<span class="string">"/Users/dingzhenkai/Downloads/i10WN.txt"</span>);</span><br><span class="line">        <span class="keyword">for</span>(String i: li)&#123;</span><br><span class="line">            <span class="comment">// 插入数据</span></span><br><span class="line">            bf.put(i);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">int</span> sp=<span class="number">0</span>;</span><br><span class="line">        <span class="keyword">int</span> sn=<span class="number">0</span>;</span><br><span class="line">        <span class="keyword">long</span> size = RamUsageEstimator.sizeOf(bf);</span><br><span class="line">        <span class="keyword">long</span> t1 = System.currentTimeMillis();</span><br><span class="line">        <span class="keyword">for</span>(String pi:li)&#123;</span><br><span class="line">            <span class="comment">// 查询数据是否在Bloom Filter里面</span></span><br><span class="line">            <span class="keyword">if</span>(bf.mightContain(pi)) sp++;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">for</span>(String ni: lin)&#123;</span><br><span class="line">            <span class="keyword">if</span>(!bf.mightContain(ni)) sn++;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">long</span> t2 = System.currentTimeMillis();</span><br><span class="line">        System.out.println(<span class="string">"bloom filter size(byte): "</span>+ size);</span><br><span class="line">        System.out.println(<span class="string">"search 10W time(ms): "</span> + (t2-t1));</span><br><span class="line">        System.out.println(<span class="string">"10W pi true positive: "</span> + sp);</span><br><span class="line">        System.out.println(<span class="string">"10W ni true negative: "</span> + sn);</span><br><span class="line"></span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p><strong>Python</strong></p>
<p>依赖库 <code>pip install pybloom</code>  <a href="https://github.com/jaybaird/python-bloomfilter" target="_blank" rel="noopener">github链接</a></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="keyword">from</span> pybloom <span class="keyword">import</span> BloomFilter</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>f = BloomFilter(capacity=<span class="number">1000</span>, error_rate=<span class="number">0.001</span>) <span class="comment"># 用 capacity与error_rate 构建Bloom Filter</span></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>[f.add(x) <span class="keyword">for</span> x <span class="keyword">in</span> range(<span class="number">10</span>)] <span class="comment"># add(x) 如果x不在f里面，返回False；如果在，返回True</span></span><br><span class="line">[<span class="literal">False</span>, <span class="literal">False</span>, <span class="literal">False</span>, <span class="literal">False</span>, <span class="literal">False</span>, <span class="literal">False</span>, <span class="literal">False</span>, <span class="literal">False</span>, <span class="literal">False</span>, <span class="literal">False</span>]</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>all([(x <span class="keyword">in</span> f) <span class="keyword">for</span> x <span class="keyword">in</span> range(<span class="number">10</span>)])</span><br><span class="line"><span class="literal">True</span></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="number">10</span> <span class="keyword">in</span> f</span><br><span class="line"><span class="literal">False</span></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="number">5</span> <span class="keyword">in</span> f</span><br><span class="line"><span class="literal">True</span></span><br></pre></td></tr></table></figure>

<p><strong>Redis</strong></p>
<p>依赖module <a href="https://github.com/RedisBloom/RedisBloom" target="_blank" rel="noopener">RedisBloom</a></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">docker pull redislabs/rebloom:2.2.4</span><br><span class="line">zkding:~ dingzhenkai$ docker run -p 6379:6379 -d --name redis-redisbloom redislabs/rebloom:2.2.4</span><br><span class="line">c6da2b5ee65f3ce8372f5f9cfdaf359452006577a0f1ce3ce4f748100f39991f</span><br><span class="line">zkding:~ dingzhenkai$ docker exec -it redis-redisbloom bash</span><br><span class="line">root@c6da2b5ee65f:/data# redis-cli  </span><br><span class="line">BF.RESERVE &#123;key&#125; &#123;error_rate&#125; &#123;capacity&#125; [EXPANSION expansion] [NONSCALING]</span><br><span class="line">127.0.0.1:6379&gt; BF.ADD mybloomfilter foo  </span><br><span class="line">(integer) 1</span><br><span class="line">127.0.0.1:6379&gt; BF.ADD mybloomfilter bar</span><br><span class="line">(integer) 1</span><br><span class="line">127.0.0.1:6379&gt; BF.ADD mybloomfilter lue</span><br><span class="line">(integer) 1</span><br><span class="line">127.0.0.1:6379&gt; BF.EXISTS mybloomfilter foo</span><br><span class="line">(integer) 1</span><br><span class="line">127.0.0.1:6379&gt; BF.EXISTS mybloomfilter fuc</span><br><span class="line">(integer) 0</span><br></pre></td></tr></table></figure>














      
      <!-- 打赏 -->
      
    </div>
    <footer class="article-footer">
      <a data-url="https://zkdingme.github.io/2020/08/18/bloom-filter-kiss/" data-id="ckqi0lno6001yyrj5aysc19g6"
        class="article-share-link">分享</a>
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/bloom-filter/" rel="tag">bloom filter</a></li></ul>

    </footer>

  </div>

  

  
  
  

  

</article>
    
  </article>
  

  
  <nav class="page-nav">
    
    <a class="extend prev" rel="prev" href="/page/2/">上一页</a><a class="page-number" href="/">1</a><a class="page-number" href="/page/2/">2</a><span class="page-number current">3</span><a class="page-number" href="/page/4/">4</a><a class="extend next" rel="next" href="/page/4/">下一页</a>
  </nav>
  
</section>
</div>

      <footer class="footer">
  <div class="outer">
    <ul class="list-inline">
      <li>
        &copy;
        2020-2021
        Bonjour Ding
      </li>
      <li>
        
          Powered by
        
        
        <a href="https://hexo.io" target="_blank">Hexo</a> Theme <a href="https://github.com/Shen-Yu/hexo-theme-ayer" target="_blank">Ayer</a>
        
      </li>
    </ul>
    <ul class="list-inline">
      <li>
        
        
        <ul class="list-inline">
  <li>PV:<span id="busuanzi_value_page_pv"></span></li>
  <li>UV:<span id="busuanzi_value_site_uv"></span></li>
</ul>
        
      </li>
      <li>
        <!-- cnzz统计 -->
        
      </li>
    </ul>
  </div>
</footer>
    <div class="to_top">
        <div class="totop" id="totop">
  <i class="ri-arrow-up-line"></i>
</div>
      </div>
    </main>
      <aside class="sidebar">
        <button class="navbar-toggle"></button>
<nav class="navbar">
  
  <div class="logo">
    <a href="/"><img src="/favicon.ico" alt="丁星乐"></a>
  </div>
  
  <ul class="nav nav-main">
    
    <li class="nav-item">
      <a class="nav-item-link" href="/">主页</a>
    </li>
    
    <li class="nav-item">
      <a class="nav-item-link" href="/archives">归档</a>
    </li>
    
    <li class="nav-item">
      <a class="nav-item-link" href="/categories">分类</a>
    </li>
    
    <li class="nav-item">
      <a class="nav-item-link" href="/tags">标签</a>
    </li>
    
    <li class="nav-item">
      <a class="nav-item-link" href="/2020/01/31/about">关于我</a>
    </li>
    
  </ul>
</nav>
<nav class="navbar navbar-bottom">
  <ul class="nav">
    <li class="nav-item">
      
      <a class="nav-item-link nav-item-search"  title="Search">
        <i class="ri-search-line"></i>
      </a>
      
      
    </li>
  </ul>
</nav>
<div class="search-form-wrap">
  <div class="local-search local-search-plugin">
  <input type="search" id="local-search-input" class="local-search-input" placeholder="Search...">
  <div id="local-search-result" class="local-search-result"></div>
</div>
</div>
      </aside>
      <div id="mask"></div>

<!-- #reward -->
<div id="reward">
  <span class="close"><i class="ri-close-line"></i></span>
  <p class="reward-p"><i class="ri-cup-line"></i>请我喝杯咖啡吧~</p>
  <div class="reward-box">
    
    <div class="reward-item">
      <img class="reward-img" src="/images/alipay.jpg">
      <span class="reward-type">支付宝</span>
    </div>
    
    
    <div class="reward-item">
      <img class="reward-img" src="/images/wechat.jpg">
      <span class="reward-type">微信</span>
    </div>
    
  </div>
</div>
      
<script src="/js/jquery-2.0.3.min.js"></script>


<script src="/js/jquery.justifiedGallery.min.js"></script>


<script src="/js/lazyload.min.js"></script>


<script src="/js/busuanzi-2.3.pure.min.js"></script>



<script src="/fancybox/jquery.fancybox.min.js"></script>




<script src="https://cdn.jsdelivr.net/npm/typed.js@2.0.11/lib/typed.min.js"></script>
<script>
  var typed = new Typed("#subtitle", {
    strings: ['芒焰藏于简单之中','江山如此多娇','会当击水三千里，自信人生二百年'],
    startDelay: 0,
    typeSpeed: 200,
    loop: true,
    backSpeed: 100,
    showCursor: true
    });
</script>




<script>
  var ayerConfig = {
    mathjax: true
  }
</script>


<script src="/js/ayer.js"></script>


<script src="https://cdn.jsdelivr.net/npm/jquery-modal@0.9.2/jquery.modal.min.js"></script>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/jquery-modal@0.9.2/jquery.modal.min.css">


<!-- Root element of PhotoSwipe. Must have class pswp. -->
<div class="pswp" tabindex="-1" role="dialog" aria-hidden="true">

    <!-- Background of PhotoSwipe. 
         It's a separate element as animating opacity is faster than rgba(). -->
    <div class="pswp__bg"></div>

    <!-- Slides wrapper with overflow:hidden. -->
    <div class="pswp__scroll-wrap">

        <!-- Container that holds slides. 
            PhotoSwipe keeps only 3 of them in the DOM to save memory.
            Don't modify these 3 pswp__item elements, data is added later on. -->
        <div class="pswp__container">
            <div class="pswp__item"></div>
            <div class="pswp__item"></div>
            <div class="pswp__item"></div>
        </div>

        <!-- Default (PhotoSwipeUI_Default) interface on top of sliding area. Can be changed. -->
        <div class="pswp__ui pswp__ui--hidden">

            <div class="pswp__top-bar">

                <!--  Controls are self-explanatory. Order can be changed. -->

                <div class="pswp__counter"></div>

                <button class="pswp__button pswp__button--close" title="Close (Esc)"></button>

                <button class="pswp__button pswp__button--share" style="display:none" title="Share"></button>

                <button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>

                <button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button>

                <!-- Preloader demo http://codepen.io/dimsemenov/pen/yyBWoR -->
                <!-- element will get class pswp__preloader--active when preloader is running -->
                <div class="pswp__preloader">
                    <div class="pswp__preloader__icn">
                        <div class="pswp__preloader__cut">
                            <div class="pswp__preloader__donut"></div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap">
                <div class="pswp__share-tooltip"></div>
            </div>

            <button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)">
            </button>

            <button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)">
            </button>

            <div class="pswp__caption">
                <div class="pswp__caption__center"></div>
            </div>

        </div>

    </div>

</div>

<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.css">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/default-skin/default-skin.css">
<script src="https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe-ui-default.min.js"></script>

<script>
    function viewer_init() {
        let pswpElement = document.querySelectorAll('.pswp')[0];
        let $imgArr = document.querySelectorAll(('.article-entry img:not(.reward-img)'))

        $imgArr.forEach(($em, i) => {
            $em.onclick = () => {
                // slider展开状态
                // todo: 这样不好，后面改成状态
                if (document.querySelector('.left-col.show')) return
                let items = []
                $imgArr.forEach(($em2, i2) => {
                    let img = $em2.getAttribute('data-idx', i2)
                    let src = $em2.getAttribute('data-target') || $em2.getAttribute('src')
                    let title = $em2.getAttribute('alt')
                    // 获得原图尺寸
                    const image = new Image()
                    image.src = src
                    items.push({
                        src: src,
                        w: image.width || $em2.width,
                        h: image.height || $em2.height,
                        title: title
                    })
                })
                var gallery = new PhotoSwipe(pswpElement, PhotoSwipeUI_Default, items, {
                    index: parseInt(i)
                });
                gallery.init()
            }
        })
    }
    viewer_init()
</script>



<script type="text/x-mathjax-config">
  MathJax.Hub.Config({
      tex2jax: {
          inlineMath: [ ['$','$'], ["\\(","\\)"]  ],
          processEscapes: true,
          skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code']
      }
  });

  MathJax.Hub.Queue(function() {
      var all = MathJax.Hub.getAllJax(), i;
      for(i=0; i < all.length; i += 1) {
          all[i].SourceElement().parentNode.className += ' has-jax';
      }
  });
</script>

<script src="https://cdn.jsdelivr.net/npm/mathjax@2.7.6/unpacked/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>


<script type="text/javascript" src="https://js.users.51.la/20544303.js"></script>
  </div>
</body>

</html>